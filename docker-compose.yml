version: '3.8'

networks:
  telemetry_net:
    driver: bridge

services:
  builder:
    image:  jonnyrembo/telemetry-system:latest
    build: .
    volumes:
      - ./:/workspace:rw 
      - ./bin:/output
    command: /usr/local/bin/build.sh
    profiles: ["build"]
    networks:
      - telemetry_net

  telemetry_server:
    image: jonnyrembo/telemetry-system:latest
    environment:
      - SOURCE_DIR=${SOURCE_DIR}
    volumes:
      - ./bin:/app:cached 
      - ./server/limits.json:/limits.json:ro
    command: 
      - /bin/sh
      - -c
      - |
        /app/telemetry_server 12345 /limits.json
    ports:
      - "12345:12345/udp"
    networks:
      - telemetry_net

  telemetry_client:
    image: jonnyrembo/telemetry-system:latest
    environment:
      - SOURCE_DIR=${SOURCE_DIR}
    volumes:
      - ${SOURCE_DIR}/bin:/app:cached 
    networks:
      - telemetry_net
    command: ["sleep", "infinity"]
    profiles: ["test"]

  functional_tests:
    image: jonnyrembo/telemetry-system:latest
    environment:
      - SOURCE_DIR=${SOURCE_DIR}
    volumes:
      - ${SOURCE_DIR}/bin:/app:ro
      - ./tests/functional_tests/test_data:/app:ro
    depends_on:
      - telemetry_server
    networks:
      - telemetry_net
    command: 
      - /bin/sh
      - -c  
      - |
        ls -la ./
        ls -la ./bin
        ls -la ${SOURCE_DIR}
        ls -la ${SOURCE_DIR}/bin
         mkdir -p /test_data
          cp -r /app/test_data/* /test_data/
          /app/functional_tests

    profiles: ["test"]

